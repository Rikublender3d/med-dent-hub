# GTM は動くが GA4 が計測されない場合の調査

## 前提：このサイトの構成

- **サイト側で読み込んでいるのは GTM だけ**（`GoogleTagManager.tsx`）
- **GA4 のタグは一切サイトコードにはない**。GA4 は **GTM コンテナ内で「タグ」として追加する想定**
- そのため「GTM は検知されたが GA4 がない」＝ **GTM 内に GA4 タグが無い／発火していない** 可能性が高い

---

## 原因候補と確認手順

### 1. GTM に GA4 タグが入っていない（最も多い）

**確認する場所**: [Tag Manager](https://tagmanager.google.com/) → 該当コンテナ → **タグ**

**あるべきタグ（どちらかで OK）**

- **A. Google タグ**（新しい形式・推奨）
  - タグの種類: **Google タグ**
  - タグ ID: `G-XXXXXXXXXX`（例: `G-HZZ47N86S7`）
  - トリガー: **すべてのページ**（必須）
- **B. GA4 設定タグ**（従来形式）
  - タグの種類: **Google アナリティクス: GA4 設定**
  - 測定 ID: `G-XXXXXXXXXX`
  - トリガー: **すべてのページ**

「Google タグ」でタグ ID に `G-XXX` を入れていれば、GA4 として正しく設定できます。**タグの種類と ID が合っていれば、次に確認するのはトリガーと公開だけです。**

**やること（タグが無い場合）**

1. タグを新規作成
2. タグの種類で「**Google タグ**」または「**Google アナリティクス: GA4 設定**」を選択
3. タグ ID／測定 ID に `G-HZZ47N86S7` を入力
4. **トリガーに「すべてのページ」を必ず設定**
5. 保存 → コンテナを**公開**

---

### 「Google タグ」でタグ ID が G-HZZ47N86S7 の場合

- **タグの種類**: 「Google タグ」のままで問題ありません（GA4 用として正しいです）。
- **タグ ID**: `G-HZZ47N86S7` で OK です。

**ここを確認する**

1. **トリガー**  
   このタグに「**すべてのページ**」または「**ページビュー - すべてのページ**」が設定されているか。  
   トリガーが無い・別のトリガーだけだと、ページを開いてもタグが発火せず、GA4 にデータが送られません。
2. **公開**  
   画面右上の「**公開**」で、このタグを含むバージョンを公開しているか。  
   未公開のままでは本番サイトには反映されません。
3. **プレビューで確認**  
   GTM の「プレビュー」で自サイトを開き、ページ読み込み時にこの「Google タグ」が **発火** と出るか確認すると確実です。

---

### 2. GA4 タグのトリガーが発火していない

**確認する場所**: GTM → **タグ** → 該当 GA4 タグの「トリガー」

- 「すべてのページ」や「ページビュー - すべてのページ」が付いているか
- トリガーに「例外」が付いていて、自サイトが除外されていないか
- 公開済みのバージョンにそのタグが含まれているか（**プレビュー**で確認すると確実）

**やること**

- GA4 設定タグのトリガーを「**すべてのページ**」にし、例外を外す
- 変更後に **公開** する

---

### 3. 測定 ID（GA4 ID）が違う

**確認する場所**

- GA4: [アナリティクス](https://analytics.google.com/) → 管理 → **データストリーム** → 該当ストリームの「測定 ID」（`G-XXXXXXXXXX`）
- GTM: 該当 GA4 設定タグの「測定 ID」

**やること**

- 上記の「測定 ID」を GTM の GA4 設定タグに**そのまま**コピーする（スペースや余分な文字なし）
- サイトの `.env` の `NEXT_PUBLIC_GA_ID` も同じ値にしておく（参照用・GTM は GTM 内の値を使う）

---

### 4. CSP で GA がブロックされている（サイト側）

このプロジェクトの CSP（`middleware.ts` と `next.config.ts`）では、以下を許可している想定。

- `script-src`: `https://www.googletagmanager.com` / `https://*.googletagmanager.com`
- `connect-src`: `https://www.google-analytics.com` / `https://*.google-analytics.com` / `https://*.googletagmanager.com`
- `img-src`: `https://www.google-analytics.com` / `https://www.googletagmanager.com`

**確認方法**

1. ブラウザの開発者ツール → **Console**
2. CSP 違反のメッセージが出ていないか確認（`blocked by Content Security Policy` など）
3. **Network** タブで `google-analytics.com` や `googletagmanager.com` をフィルタ
   - `gtag/js?id=G-XXX` や `collect` などのリクエストが **ブロック（赤）** になっていないか確認

ブロックされていた場合は、`middleware.ts` と `next.config.ts` の CSP に、必要なドメインが含まれているか見直す。

---

### 5. 広告ブロッカー・ブラウザ拡張

- 広告ブロッカーやプライバシー系拡張が `google-analytics.com` をブロックしていると、GTM は動いても GA4 にヒットが届かない。
- **シークレットモード**や別プロファイルで、拡張を無効にして同じページを開き、GA4 のリアルタイムに自分が表示されるか確認する。

---

### 6. 環境変数（サイト側）

- `NEXT_PUBLIC_GTM_ID` が空だと GTM 自体が読み込まれない（この場合は「GTM が検知された」と矛盾するので、本件では可能性は低い）
- GA4 の送信は **GTM 内の測定 ID** で行われるため、`NEXT_PUBLIC_GA_ID` が無くても GTM に正しい測定 ID が入っていれば計測はされる。  
  → 原因としては「GTM 内のタグ設定」を優先して確認する。

---

## ブラウザで GA4 が動いているか確認する方法

1. **Network**
   - `gtag/js?id=G-` が読み込まれているか
   - `google-analytics.com/g/collect` や `region1.google-analytics.com` などへ **リクエストが飛んでいるか**
2. **Google タグ アシスタント（Chrome 拡張）**
   - ページを開いた状態で起動し、**GA4 タグが「発火」** と出ているか確認
3. **GA4 リアルタイム**
   - アナリティクス → レポート → リアルタイムで、該当ページを開いたタブが「アクティブなユーザー」に数秒以内に出るか

---

## Tag Assistant で「GTM だけ見える／GA4 が出ない」場合

**Tag Assistant の表示の仕方**

- **「Google タグが見つかりました」で GTM（GTM-TZV4SGGF）だけ出る**のは、**コンテナが検知された**状態です。
- **GA4（Google タグ G-XXX）は、GTM の「中で発火したタグ」として別枠で出ることが多い**です。  
  → 一覧に **「Google タグ」や「GA4」が別行で出る**こともあれば、**GTM の詳細を開いたときの「発火したタグ」一覧にだけ出る**こともあります（拡張のバージョンや表示形式によります）。

**GTM は出るが GA4 の行が出ないとき**

1. **Tag Assistant で GTM（GTM-TZV4SGGF）をクリック／展開する**  
   「このコンテナで発火したタグ」のような一覧があれば、その中に **Google タグ（G-HZZ47N86S7）** や **GA4** が出ているか確認する。
2. **それでも GA4 が出ない場合**
   - GTM 内の「Google タグ」が**発火していない**（トリガー「すべてのページ」未設定・未公開など）
   - または Tag Assistant が「コンテナ」だけ表示し、中で発火したタグを別画面でしか見せていない  
     のどちらかです。

**確実に GA4 発火を確認する方法**

- **開発者ツール → Network** で、ページ読み込み後に  
  `gtag/js?id=G-HZZ47N86S7` または `google-analytics.com` / `region1.google-analytics.com` へのリクエストがあるか確認する。  
  → あれば GA4 は読み込まれていて送信されている。
- **GTM の「プレビュー」** でサイトを開き、左パネルの「Summary」や「Tags Fired」で **「Google タグ」が発火** と出ているか確認する。  
  → ここで発火していれば、Tag Assistant に GA4 が別行で出ていなくても、計測は動いています。

**まとめ**: Tag Assistant で「GTM だけ」と出ていても、**GA4 は GTM の内側のタグなので、GTM の詳細または「発火したタグ」一覧に出る**ことがあります。GA4 が本当に動いているかは **Network の `gtag/js` や `collect`** か **GTM プレビューの「Tags Fired」** で確認するのが確実です。

---

## チェックリスト（まとめ）

| 項目                           | 確認場所                               | 対処                                              |
| ------------------------------ | -------------------------------------- | ------------------------------------------------- |
| GTM に「GA4 設定」タグがあるか | GTM → タグ                             | 無ければ「Google アナリティクス: GA4 設定」を追加 |
| 測定 ID が正しいか             | GTM の GA4 タグ ⇔ GA4 データストリーム | 完全一致させる                                    |
| トリガーが「すべてのページ」か | GTM → タグ → トリガー                  | 「すべてのページ」を付与、例外を外す              |
| コンテナを公開したか           | GTM → 公開                             | 変更後に必ず公開                                  |
| CSP でブロックされていないか   | 開発者ツール Console / Network         | ブロックされていれば CSP を修正                   |
| 広告ブロッカー等               | ブラウザ                               | 無効 or シークレットで再確認                      |

**まず確認するなら**: GTM の「タグ」一覧に **「Google アナリティクス: GA4 設定」** があり、トリガー「すべてのページ」で **公開済み** かどうか。

---

## 本番環境だけで gtag（G-XXX）が発火しない場合

**症状**: ローカルやプレビューでは GA4 が動くが、本番（例: www.ishatohaisha.com）では `gtag/js?id=G-HZZ47N86S7` が読み込まれない／発火しない。

### 1. CSP で script がブロックされている（本番で middleware の CSP が効いている）

本番では **middleware** の CSP がレスポンスに付く。`script-src` に **`https://www.google-analytics.com`** が無いと、GTM が読み込む gtag スクリプトがブロックされることがある。

- **対応**: `src/middleware.ts` の CSP の `script-src` に `https://www.google-analytics.com` を追加する（next.config と揃える）。  
  → このリポジトリでは追加済み。デプロイ後に本番で再度確認。

### 2. GTM のトリガーが「本番の URL／ホスト名」で発火していない

トリガー「すべてのページ」に **条件が付いている** と、本番ドメインでは発火しないことがある。

- **確認**: GTM → **トリガー** → 「すべてのページ」を開く
  - 「このトリガーが発火する条件」に **ページのホスト名** や **URL** の条件（例: localhost だけ、など）が入っていないか確認。
  - 本番で発火させたいなら、**条件を削除する** か、本番のホスト名（例: `www.ishatohaisha.com`）を含める。
- **確認**: GA4（Google タグ）のタグのトリガーが、その「条件付きトリガー」だけになっていないか。

### 3. 公開バージョンに GA4 タグが入っていない

- GTM の **「バージョン」** で、**本番に公開されているバージョン** を開く。
- そのバージョンに「Google タグ（G-HZZ47N86S7）」が含まれているか確認。  
  含まれていなければ、GA4 タグを入れたワークスペースを **公開** し直す。

### 4. 本番で GTM プレビューで確認する

1. GTM で **「プレビュー」** をクリック。
2. **接続するサイトの URL に本番 URL**（例: `https://www.ishatohaisha.com`）を入力して接続。
3. 本番サイトが開いた状態で、左パネルの **「Tags Fired」** を確認。
   - 「Google タグ」が **発火** と出ていれば、GTM 側は本番でも発火している（CSP やネットワークでブロックされている可能性）。
   - **発火していない** なら、トリガー条件（上記 2）か公開バージョン（上記 3）を疑う。

### 5. 本番の開発者ツールで CSP 違反が出ていないか

本番ページを開き、開発者ツール → **Console** で次のようなメッセージが出ていないか確認する。

- `blocked by Content Security Policy`
- `Refused to load the script ... because it violates the following Content Security Policy directive: "script-src"`

出ていれば、表示されている `script-src` に `https://www.google-analytics.com` と `https://www.googletagmanager.com` が含まれるように CSP を修正する。
